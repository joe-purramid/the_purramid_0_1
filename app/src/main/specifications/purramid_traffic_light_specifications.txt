// TrafficLightService.kt
The traffic light is a vector image of a common traffic light with three colored bulbs: red, yellow, and green. It's default orientation is vertical (with the red light on top and the green light on bottom, with the yellow light in the middle), but the user can change it to be horizontal in the settings (with the red light on the left and the green light on the right, with the yellow light in the middle). When a color is "lit", its color will change from dull to shining (for example, dull red vs shining red colors). There should not be any flashing that might trigger seizures. Each light will also include an image outline that only appears when that light is lit. This is to help color blind users understand which light is active.

At launch, the app should check to see if the device has a mic array or other active mic input. This will be referred to as "mic array" going forward, regardless of what type of microphone is actually being used. The light chnages from red to yellow to green every 0.3 seconds. This sequence happens twice, then all thre elights flash in unison three times, flashing ever 0.3 seconds. Then all lights are unlit. If app initiation requires more than three seconds, the sequence should repeat.

The traffic lights act as buttons in some cases. Users can tap a light to turn it on and off. Aside from the light bulbs, traffic light has two additional buttons, a settings gear button that appears at the bottom left and and a close button made from a unicode cross in a circle at the top right. 

A rounded "Settings" menu button (ic_settings.xml) is attached to the bottom left corner of the mask. When tapped, it gracefully expands a settings menu that includes: (1) "Mode",  (2) "Orientation", (3) "Blinking Lights", (4) "Adjust Values", (5) "Add Messages", (6) "Edit Sequence", (7) "Show Time remaining", (8) "Show Timeline", and (9) "Add Another".

(1) Mode: Manual by default; the user can select between three use modes: (1a) Manual, (1b) Responsive Change, and  (1c) Timed Change. If the device does not have an active mic input, Responsive Change should be inactivated.

(2) Orientation: Vertical by default; when changed to horizontal, the traffic lights appear horizontally with red then yellow then green from left to right.

(3) Blinking lights: On by default; when turned off, color blinking is ignored whenever mentioned in app behavior. Colors are either lit or unlit based on defined usage and never blink.

(4) Adjust values: Only visible when mode is set to Responsive Change; allows the user to change the decibel values that cause color changes.

(5) Add Messages: Only visible when mode is set to Manual Change or Responsive Change; allows the user to add messages that appear beside the traffic light.

(6)Edit Squence: Only visible when mode is set to Timed Change; allows the user to create/change the time duration and color change for the Timed Change mode

(7) Show Time Remaining: Off by default, only visible when mode is set to Timed Change; shows a countdown timer of the current sequence step.

(8) Show Timeline: Off by default, only visible when mode is set to Timed Change; shows a countdown timer of the current sequence step and time values for all future sequence steps.

(9) Add Another: Create another traffic light instance. If four traffic lights are open, this setting is inactivated. This follows the behavior in the purramid_universal_requirements.txt.


(1a) Manual mode behavior: When a user taps on a color that color is lit. If the user taps on a different color, that first color is unlit and the new color is lit. If the user double-taps on the color that is lit, that color is unlit but no new color is lit.


(1b) Responsive mode behavior: When this mode is selected, ambient sound is measured using the mic array. Maxamplitude is measured every two seconds by using standard Google APIs. Based on the decibels (dB) of that sound, a specified color is lit. Green is lit with a measure of 59 dB or less. Yellow is lit with a measure of 60 dB to 79 dB. Red is lit with a measure of 80 dB or higher. If sound changes from one range to antoher, the previous color is unlit and the new color is lit. If a color is within 5 dB of the range above it, the color blinks (between its unlit and lit colors) every 0.5 seconds. This means green would blink from 55 dB to 59 dB and Yellow would blink from 75 dB to 79 dB. Colors do not blink when near a lower range. (For example, moving from 81 dB to 70 dB, red would be lit, but it would not blink.) Because maxamplitude is measured every two seconds, it is possible for decibels to increase or decrease enough to skip a range. In those cases, the color skipped is not shown. (For example,going from 81 dB to 50 dB would cause red to change green without yellow being lit.)

(4) "Adjust Values" opens a window on top of settings. (10) Three color circles form a column on the left (for left-to-right languages) and on the right (for right-to-left languages). (11) Each color then has a minimum and a maximum value text field (following in the same order of left-to-right or right-to-left based on the selected language). The text fields show the default decibel ranges. The string "dB" beside the text field (to the left or right, accordingly). The minimum value for green is 0 and the maximum 59. Yellow is mininimum 60 and maximum 79. Red is minimum 80 and maximum 120. If the user taps on a text field, a cursor appears and the system number pad appears. If a change is made to a value that is adjacent to another value, both values are changed to remain adjacent to one another. (For example, if the maximum of green is changed from 59 to 69, the minimum of yellow would automatically adjust to 70.) If a change is made to a value that crosses the entire range of its adjacent color, the middle color's range is eliminated. The numbers in those fields are replaced with the string N/A. And the other color is one dB away from the modified range. (For example, if the minimum value of red was changed from 80 to 55, the maximum value of green would be set to 54 and both yellow values would be set to N/A.

Any settings that open an additional view (like "Adjust Values) includes a (12) back arrow and a (13) close button. (12) The back arrow returns the user to previous settings view. (13) The close button closes settings and returns the user to the traffic light view.

(14) Below the color ranges is an unchecked checkbox and a string that says "Dangerous Sound Alert". After the string is (15) an information icon (a lowercase i in a circle). If the box is checked and the mic array reports a Maxamplitude value of 150 dB or higher, the red and yellow lights alternate blinking ever 0.2 seconds. In the message field for the red color is the string "WARNING". In the message field for the yellow color is the string "Notify your instructor immediately." In the message field for the green color is the string "Double-tap green to dismiss this alert." If more than one traffic light window is open, all windows display the same alert. Dismissing the alert on one window dismisses it on all of them. The alert must be dismissed before use of the traffic light returns to normal. If all traffic light windows are closed or if the app is destroyed while the alert is active, the alert does not return when the app is reopened.

(15) If the user taps the information icon, a dialog box opens with the following text: "Check this box to display an alert that says "Warning: Notify your instructor immediately." should your hardware's microphone report a sound of 150 decibels or higher. The US Occupational Safety and Health Organization projects the loudest classroom noise would reach 95 dB. 120 db is the sound of a car backfire. 150 dB is the sound of a gunshot. The Purramid is a software application dependent on the readings provided by your microphone. Purramid Learning® makes no guarantee that the sound detected is 150 db or what made the sound is a firearm. But this is the reality that US students live in, and we are committed to providing teachers any tools possible to make their classrooms places of learning and not fear." (The word "Purramid" and the phrase "Purramid Learning®" are never translated.) 


(5) "Add Messages" allows the user to add text, an image, and/or emoji to appear beside a color when it is lit (far enough away that they do not overlap with the body of the traffic light). Once the user presses Add Messages, three dialog boxes appear beside their respective lights. For left-to-right languages, the text fields appear to the right of the color. Text fields include the string "Add Message" (string/setting_add_messages). When the user taps this field, the phrase "Add Message" disappears and a cursor appears. The sytsem keyboard opens. A line may include a maximum of 27 text characdters, 10 emoji, and one image. For right-to-left languages, the message appears to the left of the lit color. The size of the text and emoji should equal 80% of the color circle. Images equal 150% of the color circle, with the center of the image aligning with the center of the color circle. Messages appear when a color is lit and disappear when it is not. If nothing is entered in a message box, nothing appears on the screen. Tapping anywhere other than the text fields ends this setting view.


(1c) Timed Change mode behavior: When switched to Timed Change mode, a play/pause button and a reset button are added to the layout of the traffic light below the body of the traffic light. The play button initiates the sequence. Until the sequence is initiated, no color is lit. Once the play button is pressed, the first color in the sequence is lit and its corresponding message is displayed. Its duration begins to countdown. This time is not shown unless the (7) "Show Time Remaining" setting is toggled on. When countdown for that sequence row elapses, the next row in the order begins, with that light lit, its message displayed, and its duration beginning to count down. This process continues until the sequence complets. At that point, all colors are unlit and all messages are removed. If two rows in a sequence use the same color, the color blinks twice at an interval of 0.3 seconds. 


(6) To create a sequence, the user must press the "Edit Sequence" button. This opens a window similar in design to an Android clock alarm interface. If a user has created sequences, they are organized alphabetically in a column. The last item in a column is the string "Create New Sequence". There can be a maximum of ten sequences saved. With the creation of the tenth sequence, the "Create New Sequence" option is hidden. If no sequences have been created, only the row "Create New Sequence" is shown.

When the user taps into an existing sequence or creates a new sequence, a list editing interface opens up. At the top is a text field with the string "Title" (string/setting_add_title) in it. When the user taps this field, the word "Title" disappears and a cursor appears. The sytsem keyboard opens. They can enter a title for this sequence up to 27 characters long. Below the title is a row with the following elements ordered left to right: (16) two parallel lines used as a reordering drag handle (ic_drag_handle.xml); (17) the numerical value of the row's position in the order, descending sequentially (starting at number 1); (18) a circle with fill 1/3 red, 1/3 yellow, and 1/3 green;  (19) a text field with "H:MM:SS: shown in it; and (20) a message field. If changes are made to the first row of a sequence, a second row appears with all the same default values as the first row except that the sequence order number increases by 1. A user can create a sequence with no more than ten rows. When they reach their tenth row, no new row is populated.

(16) A dragging motion on the reordering handle handle allows the user to change the row's order in the stack. Gracefully animate the row's movement above and insertion back into the sequence order.

(17) This number shows the order value of the row. When a row is moved in the order, the numbers change to match the new sequence order. Numbers should always be in sequence.

(18) when tapped, this circle opens a column view similar to (10) that shows three circles one with red fill, one with yellow, and one with green. When the user taps a specific color, the (18) circle fills entirely with that color. This is the color that is lit during this sequence step.

(19) This is the length of time a sequence lasts. When the user taps into the text field, the text disappears and the system number pad opens. The maximum amount of time per sequence step is 9 hours, 59 minutes, and 59 seconds (displayed H:MM:SS). Colons are added automatically. If a user enters 30, this is 30 seconds and displays as 0:00:30. If the user enters 300, this is 3 minutes, and displays as 0:03:00.

(20) This message field behaves the same as message fields in (5). Any message entered displays while this sequence step is active. If no message is netered, nothing displays.


When the user presses the play button, the sequence starts. The play icon changes to a pause icon. If the pause button is pressed, sequence time countdown is paused and the button changes to a play icon. Pressing play resumes the time countdown. If the user presses the reset button while time is running, the current row sequence starts back over at its starting value with time counting down. The lit color blinks once to show the change. If the user presses the reset button while time is paused, the current row of the sequence resets but timing does not resume until the play button is pressed. The lit color blinks once to show the change. If the user presses reset when time is paused and the sequence is at its starting value, the traffic light resets to the first row of the sequence. The color that was active blinks twice at an interval of 0.3 seconds and then the color of the first row of the sequence blinks once more. (For example, if the colors were changing from green to red, green would blink twice and red would blink once.) If both colors are the same, the light would blink three times at an interval of 0.3 seconds. The sequence does not resume timing until the play button is pressed. If the entire sequence has elapsed, behavior remains the same. Pressing reset restores the last step of the sequence and timing is paused. If the user presses reset again, the sequence entirely resets.


If (7) Show Time Remaining is toggled on, a digital clock of HH:MM:SS shows beside the active color (far enough away that it does not overlap with the body of the traffic light image). If the time value is lesson than 1 hour, no hour value is shown (MM:SS not H:MM:SS). This is intentionally different than how time displays when (19) time is set in (6) Edit Sequence. If the time value is less than 10 minutes, no tens value is shown for minutes (M:SS not MM:SS). If the time value is less than 1 minute, a minute value of 0 is used (30 seconds displays as 0:30). Thus when one hour and 5 minutes counts down to 59 minutes, time would go from 1:05:00 to 59:00. 



If (8) Show Timeline is toggled on a line the length of the traffic light appears beside it (far enough away that it does not overlap with the body of the traffic light image). Color circles with black outlines appear on the line from top to bottom in the order in which they appear in the sequence. Their position on the timeline is dependent on where in the total length of time they begin. If I had a squence with three rows, with the first row lasting 10 minutes and the other two lasting 5, the first color circle would appear at the top of the timeline. The second color circle would appear 50% of the way down the line. The third color circle would appear 75% of the way down the line. The end of the line is an empty circle. When time begins counting down, the color circle begins moving down the timeline at a speed that causes it to reach the next circle when its set time elapses. An empty circle appears where the color originally started. As it reaches the next circle, it moves behind that next color circle. When it is fully obscured, time for that sequence row has ellapsed, its color disappears, and the next color in the sequence begins to move down the timeline, leaving a second empty circle. When the final sequence color reaches the final, empty circle, it obscured by the no-fill. When it is fully obscured and an empty circle remains, the entire sequence has elapsed. Hitting the reset button returns the color to its starting circle. If (7) Show Remaining Time is also toggled on, a clock appears at the midpoint of each line segment for its respective row in the sequence. When that time reaches 0:00, it disappears, and the next clock starts counting down.


